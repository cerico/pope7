---
title: On Demand storybooks
author: ''
publishDate: Wed Jun 01 2022
displayDate: 1 Jun
cover: https://i.ibb.co/swkd4P2/ccc.jpg
setup: |
  import Layout from '../../layouts/BlogPost.astro'
  import Cool from '../../components/Author.astro'
description: hello world example
tags:
  - bluey
  - yellow
---

# Storybook: On demand deployment per branch

## The problem

Storybook is a great reference tool to see what components or elements you have availble, and how to use them in your application. When you're fleshing out your storybook, adding new components, or modifying existing compoonents you can test all this locally before submitting your pull request for code review.

But for your team-mates reviewing your pull request? If they want to have a look, they're going to have checkout your branch, and then run storybook locally. Disruptive if they are working on something else in their own branch.

At Picfair, what we wanted to be able to do something a little more streamlined.


1. 1 Create a specific url per developer, based on their username. No long unmemorable urls based on the branch
2. 2 Deploy the storybook under review to this url.
3. 3 Make the deploy on-demand, only deploy this storybook if the reviewer requests it.
4. 4 Make the level of effort required of the reviewer as low as possible.
5. 5 Notify the reviewer the storybook is deployed and ready to view.

Lets go through how we achieved it.

# Existing production storybook

We already had a production storybook set up, deploying on master branch via a github action. I'll run through how we have that set up first, and then go through how we modified that to run the on demand development storybooks. 

## Static site storybook

This is well documented on the Storybook site, but we'll recap here. Following straight from their instructions we have a build-storybook entry in our package.json.

```json
"scripts": {
  "build-storybook": "build-storybook",
  ...
```

Running the following command creates the static storybook site

```bash
npm run build-storybook
```

By default this lives in the storybook-static directory.

```bash
ls storybook-static
```

## Deploy production storybook via github action

Rather than running this locally and then handling deploy ourselves, we have a github action set up to deploy whenever master branch is pushed.

```yaml
# .github/workflows/deploy.yml
name: Storybook Deploy

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
# deployment steps all in here
```

I've truncated the deploy file here as the details of the deployment aren't relevant, and we'll see them later in the full file. The main takeaway here is we have an existing production deploy action, and we can see that in runs on a push of the master branch. What we were looking to do is have this run on other branches, on-demand, and to the reviewers own url

## Url per developer

At Picfair we have a dev server we use for Documentation and Lighthouse reports. We set up a subdomain for each developer based on their github username - for example

```html
cerico.picfair.com
```

### The goal

We wanted to be able to trigger a deploy of a storybook relative to any particular branch instead of just master, but doing it on push of branch name isn't ideal or we would just end up with endless deploys, with long unmemorable names. We wanted the deploys to be tied to a developer, not a branch - and it should be the reviewer not the author.

That means it needs to be triggered by a comment. The reviewer should be able to trigger a storybook deploy of the branch they are reviewing, by leaving a comment. 

This is where the documentation started to get a little more tricky to wade through

Firstly I created a new yaml to go alongside the existing deploy.yaml

```yaml
on: issue_comment

jobs:
  pr_commented:
    # This job only runs for pull request comments
    name: PR comment
    if: (github.event.comment.body == 'storybook')
    runs-on: ubuntu-latest
    steps:
# deployment steps here
```

We changed the push trigger to an issue_comment trigger, and eventually found we add access to the contents of a comment in `github.event.comment.body`. We didn't want the deploy to trigger anytime anyone made any comment, so here we change the if statement to only trigger if the comment is "storybook"

# Deployment steps in github action

Lets look at our production deployment steps

```yaml
# .github/workflows/deploy.yaml
...
    steps:
      - name: Checkout branch
        uses: actions/checkout@v2

      - name: Node install
        uses: actions/setup-node@v2
        with:
          node-version: '14.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Install JS Packages
        run: yarn

      - name: Build
        run: yarn build-storybook

      - name: Rsync
        uses: burnett01/rsync-deployments@4.1
        with:
          switches: -a
          path: storybook-static/
          remote_path: /var/www/html/storybook
          remote_host: sb.carlosfair.com
          remote_user: picfair
          remote_key: ${{ secrets.STORYBOOK_KEY }}
```

What we're most interested in here is the final step, the rsync step. We're using burnett01's rsync-deployment action, and for production storybook deploys we're always deploying to the same url, sb.picfair.com. 

But for dev storybook urls that url is going to change to one of the urls created above, based on the reviewers github username. So the first thing we needed to be able to do was get access to the username of the person leaving the comment.

# Using Github username

```yaml
# .github/workflows/storybook.yaml
      - name: Rsync
        uses: burnett01/rsync-deployments@4.1
        with:
          switches: -a
          path: storybook-static/
          remote_path: "/var/www/html/$USER.storybook.carlosfair.com"
          remote_host: sb.carlosfair.com
          remote_user: picfair
          remote_key: ${{ secrets.STORYBOOK_KEY }}
        env:
          USER: ${{ github.actor }}
```

Finding out the commenter username turned out to be relatively straightforward, its accessible as github.actor. We set this as an environmental variable `$USER` under `env`, and then added this to the deployment path

We're using a server running nginx for our deploys, and you may be using something completely different here, but the main takeaway is whatever method you're using, you can get that speific user based url via setting a user variable based on github.actor in the env section of whatever action you use here.

## Deploying the correct branch

Once we had this in place, it appeared to work. But there a big problem. Whatever branch you were on, it would deploy the master branch regardless. So we needed to look at the checkout action

```yaml
# .github/workflows/deploy.yaml
...
    - name: Checkout branch
    - uses: actions/checkout@v2
...
```

Documentation was tricky here again, but it appeared that you can check out the branch simply by specifying the branch

```yaml
# .github/workflows/storybook.yaml
      - name: Checkout branch
        uses: actions/checkout@v2
        with:
          ref: my-very-good-branch
```

Seemingly fixes the problem, but only if you know the name of the branch and it always uses that branch. But we needed to be able to check out any and all branches. So how to find the name of whatever branch we want deployed?

## Finding the correct branch

```yaml
# .github/workflows/storybook.yaml
      - name: Find out branch name
        id: 'get-branch'
        run: echo ::set-output name=branch::$(gh pr view $PR_NO --repo $REPO --json headRefName --jq '.headRefName')
        env:
          REPO: ${{ github.repository }}
          PR_NO: ${{ github.event.issue.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

This was decidedly not easy. I added in an extra step, running a command to get the branch name. This needed variables set for the Repo, the pr number, and a github token. This then sets a variable to the id name 'get-branch'

```yaml
# .github/workflows/storybook.yaml
      - name: Checkout branch
        uses: actions/checkout@v2
        with:
          ref: ${{ steps.get-branch.outputs.branch }}
```

The `get-branch` id is now available under `steps` and we can use to specify the branch name that should be deployed. Success!

## Notifying the reviewer of a succesful deploy

Then we needed to be able to let the reviewer know, hey youre requested deploy is ready to view. For this we added in a new step, that would leave a comment under the PR, once a branch deploy was successful.

```yaml
# .github/workflows/storybook.yaml
       - name: Add comment to PR with storybook url after succesfully deployed
        env:
          URL: ${{ github.event.issue.comments_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USER: ${{ github.actor }}
        run: |
          curl \
            -X POST \
            $URL \
            -H "Content-Type: application/json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            --data '{ "body": "Storybook deployed at https://'"$USER".storybook.carlosfair.com'"}'
```

Again, this was pretty tricky to get right. We needed three variables

1. The authentication token
2. The github url to post the comment to
3. The reviewer username to form part of the storybook url

With these variables it then runs a Curl POST command to leave a comment with the url

## In action!

![action](https://i.ibb.co/xXyDBqr/Screenshot-2022-06-01-at-15-38-58.png)

## Final workflow

```yaml
# .github/workflows/storybook.yaml
on: issue_comment

jobs:
  pr_commented:
    name: PR comment
    if: (github.event.comment.body == 'storybook')
    runs-on: ubuntu-latest
    steps:
      - id: 'get-branch'
        run: echo ::set-output name=branch::$(gh pr view $PR_NO --repo $REPO --json headRefName --jq '.headRefName')
        env:
          REPO: ${{ github.repository }}
          PR_NO: ${{ github.event.issue.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ steps.get-branch.outputs.branch }}
      
      - name: Node install
        uses: actions/setup-node@v2
        with:
          node-version: '14.x'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install JS Packages
        run: yarn
        
      - name: Build
        run: yarn build-storybook
      
      - name: Rsync
        uses: burnett01/rsync-deployments@4.1
        with:
          switches: -a
          path: storybook-static/
          remote_path: "/var/www/html/$USER.storybook.carlosfair.com"
          remote_host: sb.picfair.com
          remote_user: picfair
          remote_key: ${{ secrets.STORYBOOK_KEY }}
        env:
          USER: ${{ github.actor }}

      - name: Add comment to PR with storybook url after succesfully deployed
        env:
          URL: ${{ github.event.issue.comments_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USER: ${{ github.actor }}
        run: |
          curl \
            -X POST \
            $URL \
            -H "Content-Type: application/json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            --data '{ "body": "Storybook deployed at https://'"$USER".storybook.carlosfair.com'"}'

```



















